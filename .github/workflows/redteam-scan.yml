name: Promptfoo Redteam Scan
on:
  workflow_dispatch:

permissions:
  contents: read

env:
  NODE_VERSION: '22'
  PROMPTFOO_HOST: ${{ vars.PROMPTFOO_HOST }}
  SCAN_TEMPLATE_ID: ${{ vars.SCAN_TEMPLATE_ID }}
  TARGET_ID: ${{ vars.TARGET_ID }}
  PROMPTFOO_API_KEY: ${{ secrets.PROMPTFOO_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  PROMPTFOO_CACHE_PATH: ~/.cache/promptfoo
  PORT: 4000
  PROMPTFOO_REMOTE_GENERATION_URL: ${{ vars.PROMPTFOO_REMOTE_GENERATION_URL }}

jobs:
  evaluate:
    name: Lite Redteam Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install project dependencies
        run: |
          npm install

      - name: Start dev server
        run: |
          nohup npm run dev > /dev/null 2>&1 &
          sleep 10
          echo "Dev server started in background"

      - name: Health check
        run: |
          curl -f http://localhost:${{ env.PORT }}/health || exit 1
          echo "✅ Health check passed"

      - name: Install dependencies
        run: |
          npm install -g promptfoo@latest

      - name: Cache promptfoo
        uses: actions/cache@v5
        with:
          path: ~/.cache/promptfoo
          key: ${{ runner.os }}-promptfoo-${{ hashFiles('prompts/**') }}
          restore-keys: |
            ${{ runner.os }}-promptfoo-

      - name: Promptfoo Login
        run: |
          promptfoo auth login --host "$PROMPTFOO_HOST" --api-key "$PROMPTFOO_API_KEY"

      - name: Promptfoo Remote Generation Login
        run: |
          echo "PROMPTFOO_REMOTE_GENERATION_URL: $PROMPTFOO_REMOTE_GENERATION_URL"

      - name: Run redteam
        run: |
          promptfoo redteam run -c "$SCAN_TEMPLATE_ID" -t "$TARGET_ID" -o results.json -o report.html

      - name: Check quality gate
        run: |
          FAILURES=$(jq '.results.stats.failures' results.json)
          EVAL_ID=$(jq '.evalId' results.json)
          EVAL_URL=$(jq -r '.shareableUrl' results.json)
          echo "Eval ID: $EVAL_ID"
          echo "URL: $EVAL_URL"
          if [ "$FAILURES" -gt 0 ]; then
            echo "❌ Eval failed with $FAILURES failures"
            exit 1
          fi
          echo "✅ All tests passed!"

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: eval-results
          path: |
            results.json
            report.html

